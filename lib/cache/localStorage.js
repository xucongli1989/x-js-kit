"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getGlobalCache = getGlobalCache;
exports.setGlobalCacheName = setGlobalCacheName;
exports.add = add;
exports.remove = remove;
exports.get = get;
exports.clearExpired = clearExpired;
exports.getAutoClearExpiredTimeSpan = getAutoClearExpiredTimeSpan;
exports.setAutoClearExpiredTimeSpan = setAutoClearExpiredTimeSpan;

var _lib = require("../common/lib");

var globalCacheName = "x-js-kit-localcache";
/**
 * 自动清理过期缓存的间隔时间（毫秒），默认为30分钟
 */

var autoClearExpiredTimeSpan = 30 * 60 * 1000;
var clearExpiredIntervalId;
var isInited = false;
/**
 * 获取localStorage对象
 */

function getStore() {
  var store = (0, _lib.getLocalStorage)();

  if (!store || isInited) {
    return store;
  } //初始化


  isInited = true; //设置默认缓存值

  if (!store.getItem(globalCacheName)) {
    var defaultGlobalLocalStorage = {
      time: new Date().valueOf(),
      items: {}
    };
    store.setItem(globalCacheName, JSON.stringify(defaultGlobalLocalStorage));
  } //立即清理过期缓存


  clearExpired(); //执行定时清理过期缓存

  runClearExpiredInterval();
  return store;
} //立即初始化


getStore();

/**
 * 返回全局缓存对象
 */
function getGlobalCache() {
  var cacheValue = getStore().getItem(globalCacheName);

  if (!cacheValue) {
    return null;
  }

  return JSON.parse(cacheValue);
}
/**
 * 修改localStorage缓存的默认名称
 */


function setGlobalCacheName(name) {
  var oldValue = getStore().getItem(globalCacheName);
  getStore().removeItem(globalCacheName);
  globalCacheName = name;
  getStore().setItem(globalCacheName, oldValue);
}
/**
 * 添加数据至缓存（默认每30分钟自动清理所有过期的缓存）
 */


function add(key, value) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  cache.items[key] = value;
  getStore().setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 删除指定缓存
 */


function remove(key) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  delete cache.items[key];
  getStore().setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 读取指定缓存
 * @param key 缓存key
 * @param ignoreExpireCheck 是否忽略过期检测，默认为false.（true:即使过期，只要还没被清理，则依然返回。false:如果已过期，则删除此缓存并返回null） 
 */


function get(key) {
  var ignoreExpireCheck = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  var cache = getGlobalCache();

  if (!cache) {
    return null;
  }

  var item = cache.items[key];

  if (!item) {
    return null;
  }

  if (!ignoreExpireCheck && item.expire && item.expire < new Date().valueOf()) {
    remove(key);
    return null;
  }

  return item;
}
/**
 * 清理过期缓存
 */


function clearExpired() {
  var ch = getGlobalCache();
  if (!ch) return;
  Object.keys(ch.items).forEach(function (key) {
    var item = ch.items[key];

    if (!item || !item.expire) {
      return;
    }

    if (item.expire < new Date().valueOf()) {
      remove(key);
    }
  });
}
/**
 * 执行自动定期清理
 */


function runClearExpiredInterval() {
  if (clearExpiredIntervalId) {
    clearInterval(clearExpiredIntervalId);
  }

  clearExpiredIntervalId = setInterval(clearExpired, autoClearExpiredTimeSpan);
}
/**
 * 获取自动清理过期缓存的间隔（毫秒）
 */


function getAutoClearExpiredTimeSpan() {
  return autoClearExpiredTimeSpan;
}
/**
 * 设置自动清理过期缓存的间隔（毫秒），并按计划执行清理
 */


function setAutoClearExpiredTimeSpan(timeSpan) {
  if (timeSpan <= 0) {
    throw new Error("timeSpan must > 0.");
  }

  autoClearExpiredTimeSpan = timeSpan;
  runClearExpiredInterval();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jYWNoZS9sb2NhbFN0b3JhZ2UudHMiXSwibmFtZXMiOlsiZ2xvYmFsQ2FjaGVOYW1lIiwiYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuIiwiY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZCIsImlzSW5pdGVkIiwiZ2V0U3RvcmUiLCJzdG9yZSIsImdldEl0ZW0iLCJkZWZhdWx0R2xvYmFsTG9jYWxTdG9yYWdlIiwidGltZSIsIkRhdGUiLCJ2YWx1ZU9mIiwiaXRlbXMiLCJzZXRJdGVtIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsZWFyRXhwaXJlZCIsInJ1bkNsZWFyRXhwaXJlZEludGVydmFsIiwiZ2V0R2xvYmFsQ2FjaGUiLCJjYWNoZVZhbHVlIiwicGFyc2UiLCJzZXRHbG9iYWxDYWNoZU5hbWUiLCJuYW1lIiwib2xkVmFsdWUiLCJyZW1vdmVJdGVtIiwiYWRkIiwia2V5IiwidmFsdWUiLCJjYWNoZSIsInJlbW92ZSIsImdldCIsImlnbm9yZUV4cGlyZUNoZWNrIiwiaXRlbSIsImV4cGlyZSIsImNoIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJjbGVhckludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJnZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4iLCJzZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4iLCJ0aW1lU3BhbiIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBLElBQUlBLGVBQWUsR0FBRyxxQkFBdEI7QUFDQTs7OztBQUdBLElBQUlDLHdCQUF3QixHQUFHLEtBQUssRUFBTCxHQUFVLElBQXpDO0FBQ0EsSUFBSUMsc0JBQUo7QUFDQSxJQUFJQyxRQUFRLEdBQUcsS0FBZjtBQUVBOzs7O0FBR0EsU0FBU0MsUUFBVCxHQUE2QjtBQUN6QixNQUFNQyxLQUFLLEdBQUcsMkJBQWQ7O0FBQ0EsTUFBSSxDQUFDQSxLQUFELElBQVVGLFFBQWQsRUFBd0I7QUFDcEIsV0FBT0UsS0FBUDtBQUNILEdBSndCLENB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LFNBQVNoQixZQUFULEdBQXdCO0FBQzNCLE1BQU1rQixFQUFFLEdBQUdoQixjQUFjLEVBQXpCO0FBQ0EsTUFBSSxDQUFDZ0IsRUFBTCxFQUFTO0FBQ1RDLEVBQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZRixFQUFFLENBQUN0QixLQUFmLEVBQXNCeUIsT0FBdEIsQ0FBOEIsVUFBQVgsR0FBRyxFQUFJO0FBQ2pDLFFBQU1NLElBQUksR0FBR0UsRUFBRSxDQUFDdEIsS0FBSCxDQUFTYyxHQUFULENBQWI7O0FBQ0EsUUFBSSxDQUFDTSxJQUFELElBQVMsQ0FBQ0EsSUFBSSxDQUFDQyxNQUFuQixFQUEyQjtBQUN2QjtBQUNIOztBQUNELFFBQUlELElBQUksQ0FBQ0MsTUFBTCxHQUFjLElBQUl2QixJQUFKLEdBQVdDLE9BQVgsRUFBbEIsRUFBd0M7QUFDcENrQixNQUFBQSxNQUFNLENBQUNILEdBQUQsQ0FBTjtBQUNIO0FBQ0osR0FSRDtBQVNIO0FBRUQ7Ozs7O0FBR0EsU0FBU1QsdUJBQVQsR0FBbUM7QUFDL0IsTUFBSWQsc0JBQUosRUFBNEI7QUFDeEJtQyxJQUFBQSxhQUFhLENBQUNuQyxzQkFBRCxDQUFiO0FBQ0g7O0FBQ0RBLEVBQUFBLHNCQUFzQixHQUFHb0MsV0FBVyxDQUFDdkIsWUFBRCxFQUFlZCx3QkFBZixDQUFwQztBQUNIO0FBRUQ7Ozs7O0FBR08sU0FBU3NDLDJCQUFULEdBQXVDO0FBQzFDLFNBQU90Qyx3QkFBUDtBQUNIO0FBRUQ7Ozs7O0FBR08sU0FBU3VDLDJCQUFULENBQXFDQyxRQUFyQyxFQUF1RDtBQUMxRCxNQUFJQSxRQUFRLElBQUksQ0FBaEIsRUFBbUI7QUFDZixVQUFNLElBQUlDLEtBQUosQ0FBVSxvQkFBVixDQUFOO0FBQ0g7O0FBQ0R6QyxFQUFBQSx3QkFBd0IsR0FBR3dDLFFBQTNCO0FBQ0F6QixFQUFBQSx1QkFBdUI7QUFDMUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRMb2NhbFN0b3JhZ2UgfSBmcm9tIFwiLi4vY29tbW9uL2xpYlwiXHJcblxyXG5sZXQgZ2xvYmFsQ2FjaGVOYW1lID0gXCJ4LWpzLWtpdC1sb2NhbGNhY2hlXCJcclxuLyoqXHJcbiAqIOiHquWKqOa4heeQhui/h+acn+e8k+WtmOeahOmXtOmalOaXtumXtO+8iOavq+enku+8ie+8jOm7mOiupOS4ujMw5YiG6ZKfXHJcbiAqL1xyXG5sZXQgYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuID0gMzAgKiA2MCAqIDEwMDBcclxubGV0IGNsZWFyRXhwaXJlZEludGVydmFsSWQ6IG51bWJlclxyXG5sZXQgaXNJbml0ZWQgPSBmYWxzZVxyXG5cclxuLyoqXHJcbiAqIOiOt+WPlmxvY2FsU3RvcmFnZeWvueixoVxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0U3RvcmUoKTogU3RvcmFnZSB7XHJcbiAgICBjb25zdCBzdG9yZSA9IGdldExvY2FsU3RvcmFnZSgpXHJcbiAgICBpZiAoIXN0b3JlIHx8IGlzSW5pdGVkKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0b3JlXHJcbiAgICB9XHJcbiAgICAvL+WIneWni+WMllxyXG4gICAgaXNJbml0ZWQgPSB0cnVlXHJcbiAgICAvL+iuvue9rum7mOiupOe8k+WtmOWAvFxyXG4gICAgaWYgKCFzdG9yZS5nZXRJdGVtKGdsb2JhbENhY2hlTmFtZSkpIHtcclxuICAgICAgICBjb25zdCBkZWZhdWx0R2xvYmFsTG9jYWxTdG9yYWdlOiBHbG9iYWxDYWNoZVR5cGUgPSB7XHJcbiAgICAgICAgICAgIHRpbWU6IG5ldyBEYXRlKCkudmFsdWVPZigpLFxyXG4gICAgICAgICAgICBpdGVtczoge31cclxuICAgICAgICB9XHJcbiAgICAgICAgc3RvcmUuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIEpTT04uc3RyaW5naWZ5KGRlZmF1bHRHbG9iYWxMb2NhbFN0b3JhZ2UpKVxyXG4gICAgfVxyXG4gICAgLy/nq4vljbPmuIXnkIbov4fmnJ/nvJPlrZhcclxuICAgIGNsZWFyRXhwaXJlZCgpXHJcbiAgICAvL+aJp+ihjOWumuaXtua4heeQhui/h+acn+e8k+WtmFxyXG4gICAgcnVuQ2xlYXJFeHBpcmVkSW50ZXJ2YWwoKVxyXG4gICAgcmV0dXJuIHN0b3JlXHJcbn1cclxuLy/nq4vljbPliJ3lp4vljJZcclxuZ2V0U3RvcmUoKVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJdGVtQ29udGVudFR5cGUge1xyXG4gICAgLyoqXHJcbiAgICAgKiDlhbfkvZPnmoTnvJPlrZjlgLxcclxuICAgICAqL1xyXG4gICAgdmFsdWU6IGFueVxyXG4gICAgLyoqXHJcbiAgICAgKiDov4fmnJ/ml7bpl7TvvIzoi6XkuI3mjIflrprvvIzliJnml6Dov4fmnJ/ml7bpl7TvvIjmraTml7bpl7TkuLrvvJrku44xOTcw5bm0MeaciDHml6Uw5pe2MOWIhjDnp5LvvIhVVEPvvIzljbPljY/osIPkuJbnlYzml7bvvInliLDor6Xml6XmnJ/nmoTmr6vnp5LmlbDjgILlpoLvvJpuZXcgRGF0ZSgpLnZhbHVlT2YoKe+8iVxyXG4gICAgICovXHJcbiAgICBleHBpcmU/OiBudW1iZXJcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIEdsb2JhbENhY2hlVHlwZSB7XHJcbiAgICAvKipcclxuICAgICAqIOaXtumXtFxyXG4gICAgICovXHJcbiAgICB0aW1lOiBudW1iZXIsXHJcbiAgICAvKipcclxuICAgICAqIOaJgOaciee8k+WtmOmhuVxyXG4gICAgICovXHJcbiAgICBpdGVtczogeyBba2V5OiBzdHJpbmddOiBJdGVtQ29udGVudFR5cGUgfVxyXG59XHJcblxyXG4vKipcclxuICog6L+U5Zue5YWo5bGA57yT5a2Y5a+56LGhXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0R2xvYmFsQ2FjaGUoKTogKEdsb2JhbENhY2hlVHlwZSB8IG51bGwpIHtcclxuICAgIGNvbnN0IGNhY2hlVmFsdWUgPSBnZXRTdG9yZSgpLmdldEl0ZW0oZ2xvYmFsQ2FjaGVOYW1lKSBhcyBzdHJpbmdcclxuICAgIGlmICghY2FjaGVWYWx1ZSkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoY2FjaGVWYWx1ZSkgYXMgR2xvYmFsQ2FjaGVUeXBlXHJcbn1cclxuLyoqXHJcbiAqIOS/ruaUuWxvY2FsU3RvcmFnZee8k+WtmOeahOm7mOiupOWQjeensFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNldEdsb2JhbENhY2hlTmFtZShuYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG9sZFZhbHVlID0gZ2V0U3RvcmUoKS5nZXRJdGVtKGdsb2JhbENhY2hlTmFtZSkgYXMgc3RyaW5nO1xyXG4gICAgZ2V0U3RvcmUoKS5yZW1vdmVJdGVtKGdsb2JhbENhY2hlTmFtZSlcclxuICAgIGdsb2JhbENhY2hlTmFtZSA9IG5hbWVcclxuICAgIGdldFN0b3JlKCkuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIG9sZFZhbHVlKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDmt7vliqDmlbDmja7oh7PnvJPlrZjvvIjpu5jorqTmr48zMOWIhumSn+iHquWKqOa4heeQhuaJgOaciei/h+acn+eahOe8k+WtmO+8iVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZChrZXk6IHN0cmluZywgdmFsdWU6IEl0ZW1Db250ZW50VHlwZSkge1xyXG4gICAgY29uc3QgY2FjaGUgPSBnZXRHbG9iYWxDYWNoZSgpXHJcbiAgICBpZiAoIWNhY2hlKSB7XHJcbiAgICAgICAgcmV0dXJuXHJcbiAgICB9XHJcbiAgICBjYWNoZS5pdGVtc1trZXldID0gdmFsdWVcclxuICAgIGdldFN0b3JlKCkuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIEpTT04uc3RyaW5naWZ5KGNhY2hlKSlcclxufVxyXG5cclxuLyoqXHJcbiAqIOWIoOmZpOaMh+Wumue8k+WtmFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZShrZXk6IHN0cmluZykge1xyXG4gICAgY29uc3QgY2FjaGUgPSBnZXRHbG9iYWxDYWNoZSgpXHJcbiAgICBpZiAoIWNhY2hlKSB7XHJcbiAgICAgICAgcmV0dXJuXHJcbiAgICB9XHJcbiAgICBkZWxldGUgY2FjaGUuaXRlbXNba2V5XVxyXG4gICAgZ2V0U3RvcmUoKS5zZXRJdGVtKGdsb2JhbENhY2hlTmFtZSwgSlNPTi5zdHJpbmdpZnkoY2FjaGUpKVxyXG59XHJcblxyXG4vKipcclxuICog6K+75Y+W5oyH5a6a57yT5a2YXHJcbiAqIEBwYXJhbSBrZXkg57yT5a2Ya2V5XHJcbiAqIEBwYXJhbSBpZ25vcmVFeHBpcmVDaGVjayDmmK/lkKblv73nlaXov4fmnJ/mo4DmtYvvvIzpu5jorqTkuLpmYWxzZS7vvIh0cnVlOuWNs+S9v+i/h+acn++8jOWPquimgei/mOayoeiiq+a4heeQhu+8jOWImeS+neeEtui/lOWbnuOAgmZhbHNlOuWmguaenOW3sui/h+acn++8jOWImeWIoOmZpOatpOe8k+WtmOW5tui/lOWbnm51bGzvvIkgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0KGtleTogc3RyaW5nLCBpZ25vcmVFeHBpcmVDaGVjazogYm9vbGVhbiA9IGZhbHNlKTogSXRlbUNvbnRlbnRUeXBlIHwgbnVsbCB7XHJcbiAgICBjb25zdCBjYWNoZSA9IGdldEdsb2JhbENhY2hlKClcclxuICAgIGlmICghY2FjaGUpIHtcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG4gICAgY29uc3QgaXRlbSA9IGNhY2hlLml0ZW1zW2tleV1cclxuICAgIGlmICghaXRlbSkge1xyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcbiAgICBpZiAoIWlnbm9yZUV4cGlyZUNoZWNrICYmIGl0ZW0uZXhwaXJlICYmIGl0ZW0uZXhwaXJlIDwgbmV3IERhdGUoKS52YWx1ZU9mKCkpIHtcclxuICAgICAgICByZW1vdmUoa2V5KVxyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcbiAgICByZXR1cm4gaXRlbVxyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIOa4heeQhui/h+acn+e8k+WtmFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyRXhwaXJlZCgpIHtcclxuICAgIGNvbnN0IGNoID0gZ2V0R2xvYmFsQ2FjaGUoKVxyXG4gICAgaWYgKCFjaCkgcmV0dXJuXHJcbiAgICBPYmplY3Qua2V5cyhjaC5pdGVtcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGl0ZW0gPSBjaC5pdGVtc1trZXldXHJcbiAgICAgICAgaWYgKCFpdGVtIHx8ICFpdGVtLmV4cGlyZSkge1xyXG4gICAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGl0ZW0uZXhwaXJlIDwgbmV3IERhdGUoKS52YWx1ZU9mKCkpIHtcclxuICAgICAgICAgICAgcmVtb3ZlKGtleSlcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG59XHJcblxyXG4vKipcclxuICog5omn6KGM6Ieq5Yqo5a6a5pyf5riF55CGXHJcbiAqL1xyXG5mdW5jdGlvbiBydW5DbGVhckV4cGlyZWRJbnRlcnZhbCgpIHtcclxuICAgIGlmIChjbGVhckV4cGlyZWRJbnRlcnZhbElkKSB7XHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbChjbGVhckV4cGlyZWRJbnRlcnZhbElkKVxyXG4gICAgfVxyXG4gICAgY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGNsZWFyRXhwaXJlZCwgYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuKSBhcyBhbnlcclxufVxyXG5cclxuLyoqXHJcbiAqIOiOt+WPluiHquWKqOa4heeQhui/h+acn+e8k+WtmOeahOmXtOmalO+8iOavq+enku+8iVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEF1dG9DbGVhckV4cGlyZWRUaW1lU3BhbigpIHtcclxuICAgIHJldHVybiBhdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW5cclxufVxyXG5cclxuLyoqXHJcbiAqIOiuvue9ruiHquWKqOa4heeQhui/h+acn+e8k+WtmOeahOmXtOmalO+8iOavq+enku+8ie+8jOW5tuaMieiuoeWIkuaJp+ihjOa4heeQhlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNldEF1dG9DbGVhckV4cGlyZWRUaW1lU3Bhbih0aW1lU3BhbjogbnVtYmVyKSB7XHJcbiAgICBpZiAodGltZVNwYW4gPD0gMCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInRpbWVTcGFuIG11c3QgPiAwLlwiKVxyXG4gICAgfVxyXG4gICAgYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuID0gdGltZVNwYW5cclxuICAgIHJ1bkNsZWFyRXhwaXJlZEludGVydmFsKClcclxufSJdfQ==