"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getGlobalCache = getGlobalCache;
exports.setGlobalCacheName = setGlobalCacheName;
exports.add = add;
exports.remove = remove;
exports.get = get;
exports.clearExpired = clearExpired;
exports.getAutoClearExpiredTimeSpan = getAutoClearExpiredTimeSpan;
exports.setAutoClearExpiredTimeSpan = setAutoClearExpiredTimeSpan;

var _lib = require("../common/lib");

var globalCacheName = "x-js-kit-localcache";
/**
 * 自动清理过期缓存的间隔时间（毫秒），默认为30分钟
 */

var autoClearExpiredTimeSpan = 30 * 60 * 1000;
var clearExpiredIntervalId;

/**
 * 返回全局缓存对象
 */
function getGlobalCache() {
  var cacheValue = localStorage.getItem(globalCacheName);

  if (!cacheValue) {
    return null;
  }

  return JSON.parse(cacheValue);
}
/**
 * 修改localStorage缓存的默认名称
 */


function setGlobalCacheName(name) {
  var oldValue = localStorage.getItem(globalCacheName);
  localStorage.removeItem(globalCacheName);
  globalCacheName = name;
  localStorage.setItem(globalCacheName, oldValue);
}
/**
 * 添加数据至缓存（默认每30分钟自动清理所有过期的缓存）
 */


function add(key, value) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  cache.items[key] = value;
  localStorage.setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 删除指定缓存
 */


function remove(key) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  delete cache.items[key];
  localStorage.setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 读取指定缓存
 * @param key 缓存key
 * @param ignoreExpireCheck 是否忽略过期检测，默认为false.（true:即使过期，只要还没被清理，则依然返回。false:如果已过期，则删除此缓存并返回null） 
 */


function get(key) {
  var ignoreExpireCheck = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  var cache = getGlobalCache();

  if (!cache) {
    return null;
  }

  var item = cache.items[key];

  if (!item) {
    return null;
  }

  if (!ignoreExpireCheck && item.expire && item.expire < new Date().valueOf()) {
    remove(key);
    return null;
  }

  return item;
}
/**
 * 清理过期缓存
 */


function clearExpired() {
  var ch = getGlobalCache();
  if (!ch) return;
  Object.keys(ch.items).forEach(function (key) {
    var item = ch.items[key];

    if (!item || !item.expire) {
      return;
    }

    if (item.expire < new Date().valueOf()) {
      remove(key);
    }
  });
}
/**
 * 执行自动定期清理
 */


function runClearExpiredInterval() {
  if (clearExpiredIntervalId) {
    clearInterval(clearExpiredIntervalId);
  }

  clearExpiredIntervalId = setInterval(clearExpired, autoClearExpiredTimeSpan);
}
/**
 * 获取自动清理过期缓存的间隔（毫秒）
 */


function getAutoClearExpiredTimeSpan() {
  return autoClearExpiredTimeSpan;
}
/**
 * 设置自动清理过期缓存的间隔（毫秒），并按计划执行清理
 */


function setAutoClearExpiredTimeSpan(timeSpan) {
  if (timeSpan <= 0) {
    throw new Error("timeSpan must > 0.");
  }

  autoClearExpiredTimeSpan = timeSpan;
  runClearExpiredInterval();
}

(function () {
  if (!(0, _lib.getLocalStorage)()) {
    throw new Error("localStorage is not defined. If you are using Node.js ,you need set global.localStorage to an object like original localStorage in browser.");
  } //设置默认缓存值


  var defaultGlobalLocalStorage = {
    time: new Date().valueOf(),
    items: {}
  };

  if (!localStorage.getItem(globalCacheName)) {
    localStorage.setItem(globalCacheName, JSON.stringify(defaultGlobalLocalStorage));
  } //立即清理过期缓存


  clearExpired(); //执行定时清理过期缓存

  runClearExpiredInterval();
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jYWNoZS9sb2NhbFN0b3JhZ2UudHMiXSwibmFtZXMiOlsiZ2xvYmFsQ2FjaGVOYW1lIiwiYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuIiwiY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZCIsImdldEdsb2JhbENhY2hlIiwiY2FjaGVWYWx1ZSIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJKU09OIiwicGFyc2UiLCJzZXRHbG9iYWxDYWNoZU5hbWUiLCJuYW1lIiwib2xkVmFsdWUiLCJyZW1vdmVJdGVtIiwic2V0SXRlbSIsImFkZCIsImtleSIsInZhbHVlIiwiY2FjaGUiLCJpdGVtcyIsInN0cmluZ2lmeSIsInJlbW92ZSIsImdldCIsImlnbm9yZUV4cGlyZUNoZWNrIiwiaXRlbSIsImV4cGlyZSIsIkRhdGUiLCJ2YWx1ZU9mIiwiY2xlYXJFeHBpcmVkIiwiY2giLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsInJ1bkNsZWFyRXhwaXJlZEludGVydmFsIiwiY2xlYXJJbnRlcnZhbCIsInNldEludGVydmFsIiwiZ2V0QXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuIiwic2V0QXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuIiwidGltZVNwYW4iLCJFcnJvciIsImRlZmF1bHRHbG9iYWxMb2NhbFN0b3JhZ2UiLCJ0aW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBLElBQUlBLGVBQWUsR0FBRyxxQkFBdEI7QUFDQTs7OztBQUdBLElBQUlDLHdCQUF3QixHQUFHLEtBQUssRUFBTCxHQUFVLElBQXpDO0FBQ0EsSUFBSUMsc0JBQUo7O0FBdUJBOzs7QUFHTyxTQUFTQyxjQUFULEdBQW9EO0FBQ3ZELE1BQU1DLFVBQVUsR0FBR0MsWUFBWSxDQUFDQyxPQUFiLENBQXFCTixlQUFyQixDQUFuQjs7QUFDQSxNQUFJLENBQUNJLFVBQUwsRUFBaUI7QUFDYixXQUFPLElBQVA7QUFDSDs7QUFDRCxTQUFPRyxJQUFJLENBQUNDLEtBQUwsQ0FB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OztBQUdPLFNBQVNrQywyQkFBVCxHQUF1QztBQUMxQyxTQUFPbEMsd0JBQVA7QUFDSDtBQUVEOzs7OztBQUdPLFNBQVNtQywyQkFBVCxDQUFxQ0MsUUFBckMsRUFBdUQ7QUFDMUQsTUFBSUEsUUFBUSxJQUFJLENBQWhCLEVBQW1CO0FBQ2YsVUFBTSxJQUFJQyxLQUFKLENBQVUsb0JBQVYsQ0FBTjtBQUNIOztBQUNEckMsRUFBQUEsd0JBQXdCLEdBQUdvQyxRQUEzQjtBQUNBTCxFQUFBQSx1QkFBdUI7QUFDMUI7O0FBSUQsQ0FBQyxZQUFNO0FBQ0gsTUFBSSxDQUFDLDJCQUFMLEVBQXdCO0FBQ3BCLFVBQU0sSUFBSU0sS0FBSixDQUFVLDZJQUFWLENBQU47QUFDSCxHQUhFLENBSUg7OztBQUNBLE1BQU1DLHlCQUEwQyxHQUFHO0FBQy9DQyxJQUFBQSxJQUFJLEVBQUUsSUFBSWYsSUFBSixHQUFXQyxPQUFYLEVBRHlDO0FBRS9DUixJQUFBQSxLQUFLLEVBQUU7QUFGd0MsR0FBbkQ7O0FBSUEsTUFBSSxDQUFDYixZQUFZLENBQUNDLE9BQWIsQ0FBcUJOLGVBQXJCLENBQUwsRUFBNEM7QUFDeENLLElBQUFBLFlBQVksQ0FBQ1EsT0FBYixDQUFxQmIsZUFBckIsRUFBc0NPLElBQUksQ0FBQ1ksU0FBTCxDQUFlb0IseUJBQWYsQ0FBdEM7QUFDSCxHQVhFLENBWUg7OztBQUNBWixFQUFBQSxZQUFZLEdBYlQsQ0FjSDs7QUFDQUssRUFBQUEsdUJBQXVCO0FBQzFCLENBaEJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0TG9jYWxTdG9yYWdlIH0gZnJvbSBcIi4uL2NvbW1vbi9saWJcIlxyXG5cclxubGV0IGdsb2JhbENhY2hlTmFtZSA9IFwieC1qcy1raXQtbG9jYWxjYWNoZVwiXHJcbi8qKlxyXG4gKiDoh6rliqjmuIXnkIbov4fmnJ/nvJPlrZjnmoTpl7TpmpTml7bpl7TvvIjmr6vnp5LvvInvvIzpu5jorqTkuLozMOWIhumSn1xyXG4gKi9cclxubGV0IGF1dG9DbGVhckV4cGlyZWRUaW1lU3BhbiA9IDMwICogNjAgKiAxMDAwXHJcbmxldCBjbGVhckV4cGlyZWRJbnRlcnZhbElkOiBudW1iZXJcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSXRlbUNvbnRlbnRUeXBlIHtcclxuICAgIC8qKlxyXG4gICAgICog5YW35L2T55qE57yT5a2Y5YC8XHJcbiAgICAgKi9cclxuICAgIHZhbHVlOiBhbnlcclxuICAgIC8qKlxyXG4gICAgICog6L+H5pyf5pe26Ze077yM6Iul5LiN5oyH5a6a77yM5YiZ5peg6L+H5pyf5pe26Ze077yI5q2k5pe26Ze05Li677ya5LuOMTk3MOW5tDHmnIgx5pelMOaXtjDliIYw56eS77yIVVRD77yM5Y2z5Y2P6LCD5LiW55WM5pe277yJ5Yiw6K+l5pel5pyf55qE5q+r56eS5pWw44CC5aaC77yabmV3IERhdGUoKS52YWx1ZU9mKCnvvIlcclxuICAgICAqL1xyXG4gICAgZXhwaXJlPzogbnVtYmVyXHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBHbG9iYWxDYWNoZVR5cGUge1xyXG4gICAgLyoqXHJcbiAgICAgKiDml7bpl7RcclxuICAgICAqL1xyXG4gICAgdGltZTogbnVtYmVyLFxyXG4gICAgLyoqXHJcbiAgICAgKiDmiYDmnInnvJPlrZjpoblcclxuICAgICAqL1xyXG4gICAgaXRlbXM6IHsgW2tleTogc3RyaW5nXTogSXRlbUNvbnRlbnRUeXBlIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOi/lOWbnuWFqOWxgOe8k+WtmOWvueixoVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEdsb2JhbENhY2hlKCk6IChHbG9iYWxDYWNoZVR5cGUgfCBudWxsKSB7XHJcbiAgICBjb25zdCBjYWNoZVZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oZ2xvYmFsQ2FjaGVOYW1lKSBhcyBzdHJpbmdcclxuICAgIGlmICghY2FjaGVWYWx1ZSkge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoY2FjaGVWYWx1ZSkgYXMgR2xvYmFsQ2FjaGVUeXBlXHJcbn1cclxuLyoqXHJcbiAqIOS/ruaUuWxvY2FsU3RvcmFnZee8k+WtmOeahOm7mOiupOWQjeensFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNldEdsb2JhbENhY2hlTmFtZShuYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG9sZFZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oZ2xvYmFsQ2FjaGVOYW1lKSBhcyBzdHJpbmc7XHJcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShnbG9iYWxDYWNoZU5hbWUpXHJcbiAgICBnbG9iYWxDYWNoZU5hbWUgPSBuYW1lXHJcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIG9sZFZhbHVlKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDmt7vliqDmlbDmja7oh7PnvJPlrZjvvIjpu5jorqTmr48zMOWIhumSn+iHquWKqOa4heeQhuaJgOaciei/h+acn+eahOe8k+WtmO+8iVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZChrZXk6IHN0cmluZywgdmFsdWU6IEl0ZW1Db250ZW50VHlwZSkge1xyXG4gICAgY29uc3QgY2FjaGUgPSBnZXRHbG9iYWxDYWNoZSgpXHJcbiAgICBpZiAoIWNhY2hlKSB7XHJcbiAgICAgICAgcmV0dXJuXHJcbiAgICB9XHJcbiAgICBjYWNoZS5pdGVtc1trZXldID0gdmFsdWVcclxuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGdsb2JhbENhY2hlTmFtZSwgSlNPTi5zdHJpbmdpZnkoY2FjaGUpKVxyXG59XHJcblxyXG4vKipcclxuICog5Yig6Zmk5oyH5a6a57yT5a2YXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlKGtleTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBjYWNoZSA9IGdldEdsb2JhbENhY2hlKClcclxuICAgIGlmICghY2FjaGUpIHtcclxuICAgICAgICByZXR1cm5cclxuICAgIH1cclxuICAgIGRlbGV0ZSBjYWNoZS5pdGVtc1trZXldXHJcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIEpTT04uc3RyaW5naWZ5KGNhY2hlKSlcclxufVxyXG5cclxuLyoqXHJcbiAqIOivu+WPluaMh+Wumue8k+WtmFxyXG4gKiBAcGFyYW0ga2V5IOe8k+WtmGtleVxyXG4gKiBAcGFyYW0gaWdub3JlRXhwaXJlQ2hlY2sg5piv5ZCm5b+955Wl6L+H5pyf5qOA5rWL77yM6buY6K6k5Li6ZmFsc2Uu77yIdHJ1ZTrljbPkvb/ov4fmnJ/vvIzlj6ropoHov5jmsqHooqvmuIXnkIbvvIzliJnkvp3nhLbov5Tlm57jgIJmYWxzZTrlpoLmnpzlt7Lov4fmnJ/vvIzliJnliKDpmaTmraTnvJPlrZjlubbov5Tlm55udWxs77yJIFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldChrZXk6IHN0cmluZywgaWdub3JlRXhwaXJlQ2hlY2s6IGJvb2xlYW4gPSBmYWxzZSk6IEl0ZW1Db250ZW50VHlwZSB8IG51bGwge1xyXG4gICAgY29uc3QgY2FjaGUgPSBnZXRHbG9iYWxDYWNoZSgpXHJcbiAgICBpZiAoIWNhY2hlKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuICAgIGNvbnN0IGl0ZW0gPSBjYWNoZS5pdGVtc1trZXldXHJcbiAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG4gICAgaWYgKCFpZ25vcmVFeHBpcmVDaGVjayAmJiBpdGVtLmV4cGlyZSAmJiBpdGVtLmV4cGlyZSA8IG5ldyBEYXRlKCkudmFsdWVPZigpKSB7XHJcbiAgICAgICAgcmVtb3ZlKGtleSlcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGl0ZW1cclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDmuIXnkIbov4fmnJ/nvJPlrZhcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjbGVhckV4cGlyZWQoKSB7XHJcbiAgICBjb25zdCBjaCA9IGdldEdsb2JhbENhY2hlKClcclxuICAgIGlmICghY2gpIHJldHVyblxyXG4gICAgT2JqZWN0LmtleXMoY2guaXRlbXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICBjb25zdCBpdGVtID0gY2guaXRlbXNba2V5XVxyXG4gICAgICAgIGlmICghaXRlbSB8fCAhaXRlbS5leHBpcmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpdGVtLmV4cGlyZSA8IG5ldyBEYXRlKCkudmFsdWVPZigpKSB7XHJcbiAgICAgICAgICAgIHJlbW92ZShrZXkpXHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxufVxyXG5cclxuLyoqXHJcbiAqIOaJp+ihjOiHquWKqOWumuacn+a4heeQhlxyXG4gKi9cclxuZnVuY3Rpb24gcnVuQ2xlYXJFeHBpcmVkSW50ZXJ2YWwoKSB7XHJcbiAgICBpZiAoY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZCkge1xyXG4gICAgICAgIGNsZWFySW50ZXJ2YWwoY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZClcclxuICAgIH1cclxuICAgIGNsZWFyRXhwaXJlZEludGVydmFsSWQgPSBzZXRJbnRlcnZhbChjbGVhckV4cGlyZWQsIGF1dG9DbGVhckV4cGlyZWRUaW1lU3BhbikgYXMgYW55XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDojrflj5boh6rliqjmuIXnkIbov4fmnJ/nvJPlrZjnmoTpl7TpmpTvvIjmr6vnp5LvvIlcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4oKSB7XHJcbiAgICByZXR1cm4gYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDorr7nva7oh6rliqjmuIXnkIbov4fmnJ/nvJPlrZjnmoTpl7TpmpTvvIjmr6vnp5LvvInvvIzlubbmjInorqHliJLmiafooYzmuIXnkIZcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4odGltZVNwYW46IG51bWJlcikge1xyXG4gICAgaWYgKHRpbWVTcGFuIDw9IDApIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ0aW1lU3BhbiBtdXN0ID4gMC5cIilcclxuICAgIH1cclxuICAgIGF1dG9DbGVhckV4cGlyZWRUaW1lU3BhbiA9IHRpbWVTcGFuXHJcbiAgICBydW5DbGVhckV4cGlyZWRJbnRlcnZhbCgpXHJcbn1cclxuXHJcblxyXG5cclxuKCgpID0+IHtcclxuICAgIGlmICghZ2V0TG9jYWxTdG9yYWdlKCkpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJsb2NhbFN0b3JhZ2UgaXMgbm90IGRlZmluZWQuIElmIHlvdSBhcmUgdXNpbmcgTm9kZS5qcyAseW91IG5lZWQgc2V0IGdsb2JhbC5sb2NhbFN0b3JhZ2UgdG8gYW4gb2JqZWN0IGxpa2Ugb3JpZ2luYWwgbG9jYWxTdG9yYWdlIGluIGJyb3dzZXIuXCIpXHJcbiAgICB9XHJcbiAgICAvL+iuvue9rum7mOiupOe8k+WtmOWAvFxyXG4gICAgY29uc3QgZGVmYXVsdEdsb2JhbExvY2FsU3RvcmFnZTogR2xvYmFsQ2FjaGVUeXBlID0ge1xyXG4gICAgICAgIHRpbWU6IG5ldyBEYXRlKCkudmFsdWVPZigpLFxyXG4gICAgICAgIGl0ZW1zOiB7fVxyXG4gICAgfVxyXG4gICAgaWYgKCFsb2NhbFN0b3JhZ2UuZ2V0SXRlbShnbG9iYWxDYWNoZU5hbWUpKSB7XHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oZ2xvYmFsQ2FjaGVOYW1lLCBKU09OLnN0cmluZ2lmeShkZWZhdWx0R2xvYmFsTG9jYWxTdG9yYWdlKSlcclxuICAgIH1cclxuICAgIC8v56uL5Y2z5riF55CG6L+H5pyf57yT5a2YXHJcbiAgICBjbGVhckV4cGlyZWQoKVxyXG4gICAgLy/miafooYzlrprml7bmuIXnkIbov4fmnJ/nvJPlrZhcclxuICAgIHJ1bkNsZWFyRXhwaXJlZEludGVydmFsKClcclxufSkoKSJdfQ==