"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getGlobalCache = getGlobalCache;
exports.setGlobalCacheName = setGlobalCacheName;
exports.add = add;
exports.remove = remove;
exports.get = get;
exports.clearExpired = clearExpired;
exports.getAutoClearExpiredTimeSpan = getAutoClearExpiredTimeSpan;
exports.setAutoClearExpiredTimeSpan = setAutoClearExpiredTimeSpan;

var _lib = require("../common/lib");

var globalCacheName = "x-js-kit-localcache";
/**
 * 自动清理过期缓存的间隔时间（毫秒），默认为30分钟
 */

var autoClearExpiredTimeSpan = 30 * 60 * 1000;
var clearExpiredIntervalId;
var isInited = false;
/**
 * 获取localStorage对象
 */

function getStore() {
  var store = (0, _lib.getLocalStorage)();

  if (!store || isInited) {
    return store;
  } //初始化


  isInited = true; //设置默认缓存值

  if (!store.getItem(globalCacheName)) {
    var defaultGlobalLocalStorage = {
      time: new Date().valueOf(),
      items: {}
    };
    store.setItem(globalCacheName, JSON.stringify(defaultGlobalLocalStorage));
  } //立即清理过期缓存


  clearExpired(); //执行定时清理过期缓存

  runClearExpiredInterval();
  return store;
} //立即初始化


getStore();

/**
 * 返回全局缓存对象
 */
function getGlobalCache() {
  var cacheValue = getStore().getItem(globalCacheName);

  if (!cacheValue) {
    return null;
  }

  return JSON.parse(cacheValue);
}
/**
 * 修改localStorage缓存的默认名称
 */


function setGlobalCacheName(name) {
  var oldValue = getStore().getItem(globalCacheName);
  getStore().removeItem(globalCacheName);
  globalCacheName = name;
  getStore().setItem(globalCacheName, oldValue);
}
/**
 * 添加数据至缓存（默认每30分钟自动清理所有过期的缓存）
 */


function add(key, value) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  cache.items[key] = value;
  getStore().setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 删除指定缓存
 */


function remove(key) {
  var cache = getGlobalCache();

  if (!cache) {
    return;
  }

  delete cache.items[key];
  getStore().setItem(globalCacheName, JSON.stringify(cache));
}
/**
 * 读取指定缓存
 * @param key 缓存key
 * @param ignoreExpireCheck 是否忽略过期检测，默认为false.（true:即使过期，只要还没被清理，则依然返回。false:如果已过期，则删除此缓存并返回null） 
 */


function get(key) {
  var ignoreExpireCheck = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  var cache = getGlobalCache();

  if (!cache) {
    return null;
  }

  var item = cache.items[key];

  if (!item) {
    return null;
  }

  if (!ignoreExpireCheck && item.expire && item.expire < new Date().valueOf()) {
    remove(key);
    return null;
  }

  return item;
}
/**
 * 清理过期缓存
 */


function clearExpired() {
  var ch = getGlobalCache();
  if (!ch) return;
  Object.keys(ch.items).forEach(function (key) {
    var item = ch.items[key];

    if (!item || !item.expire) {
      return;
    }

    if (item.expire < new Date().valueOf()) {
      remove(key);
    }
  });
}
/**
 * 执行自动定期清理
 */


function runClearExpiredInterval() {
  if (clearExpiredIntervalId) {
    clearInterval(clearExpiredIntervalId);
  }

  clearExpiredIntervalId = setInterval(clearExpired, autoClearExpiredTimeSpan);
}
/**
 * 获取自动清理过期缓存的间隔（毫秒）
 */


function getAutoClearExpiredTimeSpan() {
  return autoClearExpiredTimeSpan;
}
/**
 * 设置自动清理过期缓存的间隔（毫秒），并按计划执行清理
 */


function setAutoClearExpiredTimeSpan(timeSpan) {
  if (timeSpan <= 0) {
    throw new Error("timeSpan must > 0.");
  }

  autoClearExpiredTimeSpan = timeSpan;
  runClearExpiredInterval();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jYWNoZS9sb2NhbFN0b3JhZ2UudHMiXSwibmFtZXMiOlsiZ2xvYmFsQ2FjaGVOYW1lIiwiYXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuIiwiY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZCIsImlzSW5pdGVkIiwiZ2V0U3RvcmUiLCJzdG9yZSIsImdldEl0ZW0iLCJkZWZhdWx0R2xvYmFsTG9jYWxTdG9yYWdlIiwidGltZSIsIkRhdGUiLCJ2YWx1ZU9mIiwiaXRlbXMiLCJzZXRJdGVtIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsZWFyRXhwaXJlZCIsInJ1bkNsZWFyRXhwaXJlZEludGVydmFsIiwiZ2V0R2xvYmFsQ2FjaGUiLCJjYWNoZVZhbHVlIiwicGFyc2UiLCJzZXRHbG9iYWxDYWNoZU5hbWUiLCJuYW1lIiwib2xkVmFsdWUiLCJyZW1vdmVJdGVtIiwiYWRkIiwia2V5IiwidmFsdWUiLCJjYWNoZSIsInJlbW92ZSIsImdldCIsImlnbm9yZUV4cGlyZUNoZWNrIiwiaXRlbSIsImV4cGlyZSIsImNoIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJjbGVhckludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJnZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4iLCJzZXRBdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4iLCJ0aW1lU3BhbiIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBLElBQUlBLGVBQWUsR0FBRyxxQkFBdEI7QUFDQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUMsd0JBQXdCLEdBQUcsS0FBSyxFQUFMLEdBQVUsSUFBekM7QUFDQSxJQUFJQyxzQkFBSjtBQUNBLElBQUlDLFFBQVEsR0FBRyxLQUFmO0FBRUE7QUFDQTtBQUNBOztBQUNBLFNBQVNDLFFBQVQsR0FBd0M7QUFDcEMsTUFBTUMsS0FBSyxHQUFHLDJCQUFkOztBQUNBLE1BQUksQ0FBQ0EsS0FBRCxJQUFVRixRQUFkLEVBQXdCO0FBQ3BCLFdBQU9FLEtB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LEVBQUFBLHVCQUF1QjtBQUMxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldExvY2FsU3RvcmFnZSB9IGZyb20gXCIuLi9jb21tb24vbGliXCJcclxuXHJcbmxldCBnbG9iYWxDYWNoZU5hbWUgPSBcIngtanMta2l0LWxvY2FsY2FjaGVcIlxyXG4vKipcclxuICog6Ieq5Yqo5riF55CG6L+H5pyf57yT5a2Y55qE6Ze06ZqU5pe26Ze077yI5q+r56eS77yJ77yM6buY6K6k5Li6MzDliIbpkp9cclxuICovXHJcbmxldCBhdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4gPSAzMCAqIDYwICogMTAwMFxyXG5sZXQgY2xlYXJFeHBpcmVkSW50ZXJ2YWxJZDogbnVtYmVyXHJcbmxldCBpc0luaXRlZCA9IGZhbHNlXHJcblxyXG4vKipcclxuICog6I635Y+WbG9jYWxTdG9yYWdl5a+56LGhXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRTdG9yZTxWYWx1ZVR5cGU+KCk6IFN0b3JhZ2Uge1xyXG4gICAgY29uc3Qgc3RvcmUgPSBnZXRMb2NhbFN0b3JhZ2UoKVxyXG4gICAgaWYgKCFzdG9yZSB8fCBpc0luaXRlZCkge1xyXG4gICAgICAgIHJldHVybiBzdG9yZVxyXG4gICAgfVxyXG4gICAgLy/liJ3lp4vljJZcclxuICAgIGlzSW5pdGVkID0gdHJ1ZVxyXG4gICAgLy/orr7nva7pu5jorqTnvJPlrZjlgLxcclxuICAgIGlmICghc3RvcmUuZ2V0SXRlbShnbG9iYWxDYWNoZU5hbWUpKSB7XHJcbiAgICAgICAgY29uc3QgZGVmYXVsdEdsb2JhbExvY2FsU3RvcmFnZTogR2xvYmFsQ2FjaGVUeXBlPFZhbHVlVHlwZT4gPSB7XHJcbiAgICAgICAgICAgIHRpbWU6IG5ldyBEYXRlKCkudmFsdWVPZigpLFxyXG4gICAgICAgICAgICBpdGVtczoge31cclxuICAgICAgICB9XHJcbiAgICAgICAgc3RvcmUuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIEpTT04uc3RyaW5naWZ5KGRlZmF1bHRHbG9iYWxMb2NhbFN0b3JhZ2UpKVxyXG4gICAgfVxyXG4gICAgLy/nq4vljbPmuIXnkIbov4fmnJ/nvJPlrZhcclxuICAgIGNsZWFyRXhwaXJlZCgpXHJcbiAgICAvL+aJp+ihjOWumuaXtua4heeQhui/h+acn+e8k+WtmFxyXG4gICAgcnVuQ2xlYXJFeHBpcmVkSW50ZXJ2YWwoKVxyXG4gICAgcmV0dXJuIHN0b3JlXHJcbn1cclxuLy/nq4vljbPliJ3lp4vljJZcclxuZ2V0U3RvcmUoKVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJdGVtQ29udGVudFR5cGU8VmFsdWVUeXBlPiB7XHJcbiAgICAvKipcclxuICAgICAqIOWFt+S9k+eahOe8k+WtmOWAvFxyXG4gICAgICovXHJcbiAgICB2YWx1ZTogVmFsdWVUeXBlXHJcbiAgICAvKipcclxuICAgICAqIOi/h+acn+aXtumXtO+8jOiLpeS4jeaMh+Wumu+8jOWImeaXoOi/h+acn+aXtumXtO+8iOatpOaXtumXtOS4uu+8muS7jjE5NzDlubQx5pyIMeaXpTDml7Yw5YiGMOenku+8iFVUQ++8jOWNs+WNj+iwg+S4lueVjOaXtu+8ieWIsOivpeaXpeacn+eahOavq+enkuaVsOOAguWmgu+8mm5ldyBEYXRlKCkudmFsdWVPZigp77yJXHJcbiAgICAgKi9cclxuICAgIGV4cGlyZT86IG51bWJlclxyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgR2xvYmFsQ2FjaGVUeXBlPFZhbHVlVHlwZT4ge1xyXG4gICAgLyoqXHJcbiAgICAgKiDml7bpl7RcclxuICAgICAqL1xyXG4gICAgdGltZTogbnVtYmVyLFxyXG4gICAgLyoqXHJcbiAgICAgKiDmiYDmnInnvJPlrZjpoblcclxuICAgICAqL1xyXG4gICAgaXRlbXM6IHsgW2tleTogc3RyaW5nXTogSXRlbUNvbnRlbnRUeXBlPFZhbHVlVHlwZT4gfVxyXG59XHJcblxyXG4vKipcclxuICog6L+U5Zue5YWo5bGA57yT5a2Y5a+56LGhXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0R2xvYmFsQ2FjaGU8VmFsdWVUeXBlPigpOiAoR2xvYmFsQ2FjaGVUeXBlPFZhbHVlVHlwZT4gfCBudWxsKSB7XHJcbiAgICBjb25zdCBjYWNoZVZhbHVlID0gZ2V0U3RvcmUoKS5nZXRJdGVtKGdsb2JhbENhY2hlTmFtZSkgYXMgc3RyaW5nXHJcbiAgICBpZiAoIWNhY2hlVmFsdWUpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiBKU09OLnBhcnNlKGNhY2hlVmFsdWUpIGFzIEdsb2JhbENhY2hlVHlwZTxWYWx1ZVR5cGU+XHJcbn1cclxuLyoqXHJcbiAqIOS/ruaUuWxvY2FsU3RvcmFnZee8k+WtmOeahOm7mOiupOWQjeensFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNldEdsb2JhbENhY2hlTmFtZShuYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG9sZFZhbHVlID0gZ2V0U3RvcmUoKS5nZXRJdGVtKGdsb2JhbENhY2hlTmFtZSkgYXMgc3RyaW5nO1xyXG4gICAgZ2V0U3RvcmUoKS5yZW1vdmVJdGVtKGdsb2JhbENhY2hlTmFtZSlcclxuICAgIGdsb2JhbENhY2hlTmFtZSA9IG5hbWVcclxuICAgIGdldFN0b3JlKCkuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIG9sZFZhbHVlKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDmt7vliqDmlbDmja7oh7PnvJPlrZjvvIjpu5jorqTmr48zMOWIhumSn+iHquWKqOa4heeQhuaJgOaciei/h+acn+eahOe8k+WtmO+8iVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZDxWYWx1ZVR5cGU+KGtleTogc3RyaW5nLCB2YWx1ZTogSXRlbUNvbnRlbnRUeXBlPFZhbHVlVHlwZT4pIHtcclxuICAgIGNvbnN0IGNhY2hlID0gZ2V0R2xvYmFsQ2FjaGUoKVxyXG4gICAgaWYgKCFjYWNoZSkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG4gICAgY2FjaGUuaXRlbXNba2V5XSA9IHZhbHVlXHJcbiAgICBnZXRTdG9yZSgpLnNldEl0ZW0oZ2xvYmFsQ2FjaGVOYW1lLCBKU09OLnN0cmluZ2lmeShjYWNoZSkpXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDliKDpmaTmjIflrprnvJPlrZhcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmUoa2V5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGNhY2hlID0gZ2V0R2xvYmFsQ2FjaGUoKVxyXG4gICAgaWYgKCFjYWNoZSkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgfVxyXG4gICAgZGVsZXRlIGNhY2hlLml0ZW1zW2tleV1cclxuICAgIGdldFN0b3JlKCkuc2V0SXRlbShnbG9iYWxDYWNoZU5hbWUsIEpTT04uc3RyaW5naWZ5KGNhY2hlKSlcclxufVxyXG5cclxuLyoqXHJcbiAqIOivu+WPluaMh+Wumue8k+WtmFxyXG4gKiBAcGFyYW0ga2V5IOe8k+WtmGtleVxyXG4gKiBAcGFyYW0gaWdub3JlRXhwaXJlQ2hlY2sg5piv5ZCm5b+955Wl6L+H5pyf5qOA5rWL77yM6buY6K6k5Li6ZmFsc2Uu77yIdHJ1ZTrljbPkvb/ov4fmnJ/vvIzlj6ropoHov5jmsqHooqvmuIXnkIbvvIzliJnkvp3nhLbov5Tlm57jgIJmYWxzZTrlpoLmnpzlt7Lov4fmnJ/vvIzliJnliKDpmaTmraTnvJPlrZjlubbov5Tlm55udWxs77yJIFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldDxWYWx1ZVR5cGU+KGtleTogc3RyaW5nLCBpZ25vcmVFeHBpcmVDaGVjazogYm9vbGVhbiA9IGZhbHNlKTogSXRlbUNvbnRlbnRUeXBlPFZhbHVlVHlwZT4gfCBudWxsIHtcclxuICAgIGNvbnN0IGNhY2hlID0gZ2V0R2xvYmFsQ2FjaGUoKVxyXG4gICAgaWYgKCFjYWNoZSkge1xyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcbiAgICBjb25zdCBpdGVtID0gY2FjaGUuaXRlbXNba2V5XSBhcyBJdGVtQ29udGVudFR5cGU8VmFsdWVUeXBlPlxyXG4gICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuICAgIGlmICghaWdub3JlRXhwaXJlQ2hlY2sgJiYgaXRlbS5leHBpcmUgJiYgaXRlbS5leHBpcmUgPCBuZXcgRGF0ZSgpLnZhbHVlT2YoKSkge1xyXG4gICAgICAgIHJlbW92ZShrZXkpXHJcbiAgICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuICAgIHJldHVybiBpdGVtXHJcbn1cclxuXHJcblxyXG4vKipcclxuICog5riF55CG6L+H5pyf57yT5a2YXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJFeHBpcmVkKCkge1xyXG4gICAgY29uc3QgY2ggPSBnZXRHbG9iYWxDYWNoZSgpXHJcbiAgICBpZiAoIWNoKSByZXR1cm5cclxuICAgIE9iamVjdC5rZXlzKGNoLml0ZW1zKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IGNoLml0ZW1zW2tleV1cclxuICAgICAgICBpZiAoIWl0ZW0gfHwgIWl0ZW0uZXhwaXJlKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaXRlbS5leHBpcmUgPCBuZXcgRGF0ZSgpLnZhbHVlT2YoKSkge1xyXG4gICAgICAgICAgICByZW1vdmUoa2V5KVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDmiafooYzoh6rliqjlrprmnJ/muIXnkIZcclxuICovXHJcbmZ1bmN0aW9uIHJ1bkNsZWFyRXhwaXJlZEludGVydmFsKCkge1xyXG4gICAgaWYgKGNsZWFyRXhwaXJlZEludGVydmFsSWQpIHtcclxuICAgICAgICBjbGVhckludGVydmFsKGNsZWFyRXhwaXJlZEludGVydmFsSWQpXHJcbiAgICB9XHJcbiAgICBjbGVhckV4cGlyZWRJbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoY2xlYXJFeHBpcmVkLCBhdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4pIGFzIGFueVxyXG59XHJcblxyXG4vKipcclxuICog6I635Y+W6Ieq5Yqo5riF55CG6L+H5pyf57yT5a2Y55qE6Ze06ZqU77yI5q+r56eS77yJXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0QXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuKCkge1xyXG4gICAgcmV0dXJuIGF1dG9DbGVhckV4cGlyZWRUaW1lU3BhblxyXG59XHJcblxyXG4vKipcclxuICog6K6+572u6Ieq5Yqo5riF55CG6L+H5pyf57yT5a2Y55qE6Ze06ZqU77yI5q+r56eS77yJ77yM5bm25oyJ6K6h5YiS5omn6KGM5riF55CGXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gc2V0QXV0b0NsZWFyRXhwaXJlZFRpbWVTcGFuKHRpbWVTcGFuOiBudW1iZXIpIHtcclxuICAgIGlmICh0aW1lU3BhbiA8PSAwKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidGltZVNwYW4gbXVzdCA+IDAuXCIpXHJcbiAgICB9XHJcbiAgICBhdXRvQ2xlYXJFeHBpcmVkVGltZVNwYW4gPSB0aW1lU3BhblxyXG4gICAgcnVuQ2xlYXJFeHBpcmVkSW50ZXJ2YWwoKVxyXG59Il19